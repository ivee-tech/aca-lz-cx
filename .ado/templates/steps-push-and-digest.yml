# Template: Push image & capture digest
# Parameters:
#   repository
#   tags (multiline string, first tag assumed canonical for digest capture)
#   imageRefForDigest (repository:tag used to inspect)
#   acrLoginServer

parameters:
  - name: repository
    type: string
  - name: tags
    type: string
  - name: imageRefForDigest
    type: string
  - name: acrLoginServer
    type: string

steps:
  - task: Docker@2
    displayName: 'Push image'
    inputs:
      command: push
      repository: '${{ parameters.repository }}'
      tags: |
        ${{ parameters.tags }}

  - script: |
      echo "Pushed image references:" 
      while IFS= read -r tag; do
        [ -z "$tag" ] && continue
        echo "  ${{ parameters.acrLoginServer }}/${{ parameters.repository }}:$tag"
      done
    displayName: 'Summarize image'

  - script: |
      set -e
      DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ parameters.acrLoginServer }}/${{ parameters.imageRefForDigest }} | awk -F'@' '{print $2}')
      echo "imageDigest=$DIGEST" > image-metadata.txt
      echo "##vso[task.setvariable variable=imageDigest;isOutput=true]$DIGEST"
      echo "Image digest: $DIGEST"
    displayName: 'Capture image digest'
    name: captureDigest

  - publish: image-metadata.txt
    artifact: image-metadata
    displayName: 'Publish image metadata artifact'
