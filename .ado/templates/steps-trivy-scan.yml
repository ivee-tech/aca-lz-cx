# Template: Trivy Vulnerability Scan (fails on CRITICAL count > 0)
# Parameters:
#   imageRef: local image reference (e.g. repository:tag)
#   artifactPrefix: prefix for artifact names (e.g. backend, frontend)
#   failOnCritical: bool (string) 'true'/'false'
#   severities: e.g. HIGH,CRITICAL
#   ignoreUnfixed: 'true' or 'false'

parameters:
  - name: imageRef
    type: string
  - name: artifactPrefix
    type: string
  - name: failOnCritical
    type: string
    default: 'true'
  - name: severities
    type: string
    default: 'HIGH,CRITICAL'
  - name: ignoreUnfixed
    type: string
    default: 'true'

steps:
  - script: |
      set -e
      echo "Installing Trivy (keyring method) + jq..."
      sudo apt-get update -y
      sudo apt-get install -y wget gnupg jq
      wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
      echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb generic main" | sudo tee /etc/apt/sources.list.d/trivy.list
      sudo apt-get update -y
      sudo apt-get install -y trivy
      trivy --version
      TARGET_IMAGE='${{ parameters.imageRef }}'
      echo "Scanning image: $TARGET_IMAGE"
      TRIVY_ARGS="--severity ${{ parameters.severities }} --no-progress"
      if [ "${{ parameters.ignoreUnfixed }}" = "true" ]; then
        TRIVY_ARGS="$TRIVY_ARGS --ignore-unfixed"
      fi
      # Generate SARIF output (single authoritative report)
      trivy image $TRIVY_ARGS -f sarif -o trivy-report.sarif "$TARGET_IMAGE"
      # Generate ephemeral JSON (not published) only for counting CRITICAL findings
      trivy image $TRIVY_ARGS -f json -o trivy-ephemeral.json "$TARGET_IMAGE" >/dev/null 2>&1 || true
      CRIT_COUNT=$(jq '[ .Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL") ] | length' trivy-ephemeral.json 2>/dev/null || echo 0)
      echo "Critical vulnerability count: $CRIT_COUNT"
      if [ "${{ parameters.failOnCritical }}" = "true" ] && [ "$CRIT_COUNT" -gt 0 ]; then
        echo "Found CRITICAL vulnerabilities." >&2
        # exit 1
      fi
    displayName: 'Security: Trivy scan (${{ parameters.imageRef }})'
    env:
      TZ: UTC

  - publish: trivy-report.sarif
    artifact: security-trivy-${{ parameters.artifactPrefix }}-sarif
    displayName: 'Publish Trivy SARIF report'
