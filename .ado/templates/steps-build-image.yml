# Template: Build Docker Image
# Usage:
# - template: .ado/templates/steps-build-image.yml@self
#   parameters:
#     repository: myapp
#     dockerfile: path/to/Dockerfile
#     buildContext: .
#     tags: |
#       $(imageTag)
#       latest
#     additionalBuildArgs: ''

parameters:
  - name: repository
    type: string
  - name: dockerfile
    type: string
  - name: buildContext
    type: string
  - name: tags
    type: string
  - name: additionalBuildArgs
    type: string
    default: ''

steps:
  - task: Docker@2
    displayName: 'Build image ($(repository))'
    inputs:
      command: build
      repository: '${{ parameters.repository }}'
      Dockerfile: '${{ parameters.dockerfile }}'
      buildContext: '${{ parameters.buildContext }}'
      arguments: '${{ parameters.additionalBuildArgs }}'
      tags: |
        ${{ parameters.tags }}
  - script: |
      echo "Listing images for repository ${{ parameters.repository }} after build:" 
      docker images --format '{{.Repository}}:{{.Tag}}\t{{.ID}}' | grep '${{ parameters.repository }}' || echo 'No images matched filter.'
    displayName: 'Debug: List built image tags'
